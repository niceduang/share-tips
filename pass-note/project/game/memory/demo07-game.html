<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Document</title>
	<style type="text/css">
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
			-webkit-tap-highlight-color: rgba(0, 0, 0, 0);
		}
		.wrap {
			position: relative;
		}
		.game {
			width: 600px;
			margin: 0 auto;
			overflow: hidden;
		}
		.card {
			position: relative;
			float: left;
			width: 150px;
			height: 150px;
			text-align: center;
			-webkit-perspective: 500px;
			perspective: 500px;
			cursor: pointer;
			border: 1px solid #000;
			overflow: hidden;
		}
		.card .inside {
			width: 100%;
			height: 100%;
			display: block;
			transform-style: preserve-3d;
			transition: 0.4s ease-in-out;
			background: white;
		}
		.card .inside.picked, .card .inside.matched {
			transform: rotateY(180deg);
		}
		.card .inside.matched {
			animation: 1s matchAnim ease-in-out;
			animation-delay: 0.4s;
		}
		.card .front,
		.card .back {
			-webkit-backface-visibility: hidden;
			backface-visibility: hidden;
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			padding: 20px;
		}
		.card .front img,
		.card .back img {
			display: block;
			max-width: 100%;
			max-height: 100%;
			margin: 0 auto;
		}
		.card .front {
			transform: rotateY(-180deg);
		}
		.card .back {
			transform: rotateX(0deg);
		}
		@keyframes matchAnim {
			0% {
				background: #bcffcc;
			}
			100% {
				background: white;
			}
		}
		/* ----del----- */
		.modal{display: none;position: fixed;left: 0;top: 0;right: 0;bottom: 0;background-color: rgba(0,0,0,0.8);}
		.control{
			position: absolute;left: 100px;right: 100px;top: 50%;
			display: flex;
			flex-flow: row nowrap;
			justify-content: space-around;
		}
		.control input{height: 30px;line-height: 30px;}
	</style>
</head>
<body>
	<div class="wrap">
		<div class="game"></div>
	</div>
	<div class="modal">
		<div class="control">
			<input type="button" value="restart" />
			<input type="button" value="reset" />
			<input type="button" value="nextLevel" />
		</div>
	</div>
	<script src="http://wq.360buyimg.com/fd/promote/base/zepto.min.js"></script>
	<script type="text/javascript">
		var dataLevel = [{
							"level":1,
							"data":[
										{name: "css3",img: "https://s3-us-west-2.amazonaws.com/s.cdpn.io/74196/css3-logo.png",id: 1},
										{name: "html5",img: "https://s3-us-west-2.amazonaws.com/s.cdpn.io/74196/html5-logo.png",id: 2}
									],
							"duration":8
						},{
							"level":2,
							"data":[
										{name: "css3",img: "https://s3-us-west-2.amazonaws.com/s.cdpn.io/74196/css3-logo.png",id: 1},
										{name: "html5",img: "https://s3-us-west-2.amazonaws.com/s.cdpn.io/74196/html5-logo.png",id: 2},
										{name: "jquery",img: "https://s3-us-west-2.amazonaws.com/s.cdpn.io/74196/jquery-logo.png",id: 3}
									],
							"duration":12
						},{
							"level":3,
							"data":[
										{name: "css3",img: "https://s3-us-west-2.amazonaws.com/s.cdpn.io/74196/css3-logo.png",id: 1},
										{name: "html5",img: "https://s3-us-west-2.amazonaws.com/s.cdpn.io/74196/html5-logo.png",id: 2},
										{name: "jquery",img: "https://s3-us-west-2.amazonaws.com/s.cdpn.io/74196/jquery-logo.png",id: 3},
										{name: "javascript",img: "https://s3-us-west-2.amazonaws.com/s.cdpn.io/74196/js-logo.png",id: 4}
									],
							"duration":18
						},{
							"level":4,
							"data":[
										{name: "css3",img: "https://s3-us-west-2.amazonaws.com/s.cdpn.io/74196/css3-logo.png",id: 1},
										{name: "html5",img: "https://s3-us-west-2.amazonaws.com/s.cdpn.io/74196/html5-logo.png",id: 2},
										{name: "jquery",img: "https://s3-us-west-2.amazonaws.com/s.cdpn.io/74196/jquery-logo.png",id: 3},
										{name: "javascript",img: "https://s3-us-west-2.amazonaws.com/s.cdpn.io/74196/js-logo.png",id: 4},
										{name: "node",img: "https://s3-us-west-2.amazonaws.com/s.cdpn.io/74196/nodejs-logo.png",id: 5}
									],
							"duration":20
						},{
							"level":5,
							"data":[
										{name: "css3",img: "https://s3-us-west-2.amazonaws.com/s.cdpn.io/74196/css3-logo.png",id: 1},
										{name: "html5",img: "https://s3-us-west-2.amazonaws.com/s.cdpn.io/74196/html5-logo.png",id: 2},
										{name: "jquery",img: "https://s3-us-west-2.amazonaws.com/s.cdpn.io/74196/jquery-logo.png",id: 3},
										{name: "javascript",img: "https://s3-us-west-2.amazonaws.com/s.cdpn.io/74196/js-logo.png",id: 4},
										{name: "node",img: "https://s3-us-west-2.amazonaws.com/s.cdpn.io/74196/nodejs-logo.png",id: 5},
										{name: "python",img: "https://s3-us-west-2.amazonaws.com/s.cdpn.io/74196/python-logo.png",id: 6}
									],
							"duration":30
						}];
	</script>
	<script type="text/javascript">
		/**
		 * 单关数据重新更新
		 * 单次匹配成功用时
		 * 得分计算
		 * start
		 * reset
		 * restart
		 * nextLevel
		 * clearTimer
		 */
		/**
		 * 得分规则:考虑耗时,考虑点击次数,考虑单个匹配耗时
		 * 1.点击次数||有效点击次数
		 * 2.每匹配一个增加10分*(总块数/次数)
		 * 2.单关耗时/总时间*10
		 * 积分规则：(minClicked/minClicked+clickedTimes),次值会随着所点击次数的增加而变小,不管是以单次算还是以总次数算
		 */
		function Memory(data) {
			this.$game = $(".game");
			this.$modal = $(".modal");
			this.ctls = $('.control input[type="button"]');
			this.data = data || [];
			this.totalLevel = this.data.length;
			// 分值参考
			this.reScore = 10;
			// 关卡
			this.level = 1;
			// 生命值
			this.lifeValue = 2;
			// 积分记录
			this.score = 0;
			// 玩家数据存储
			this.userInfo = [];
		}
		Memory.prototype = {
			init: function() {
				this.info = this.data[this.level - 1];
				this.arrData = this.info.data || [];
				this.duration = this.info.duration || 0;
				this.timer = null;
				this.flag = false;
				this.guess = null;
				this.arrCards = this.arrData.concat(this.arrData);
				// 单关用时
				this.usedTime = 0;
				// 是否超时
				this.isOutTime = false;
				// 单关点击次数
				this.clickedTimes = 0;
				// 单次匹配点击次数
				this.iTimes = 0;
				// 过关最小点击次数
				this.minClickedTimes = this.arrCards.length;
				this.setHtml();
				this.updateLevel();
				this.updateTime();
			},
			start: function() {
				this.init();
				this.setTimer();
				this.addEvent();
			},
			setHtml: function() {
				this.shuffleCards(this.arrCards);
				this.html = this.buildHTML();
				this.$game.html(this.html);
				this.$memoryCards = $(".card");
			},
			rmoveEvent: function() {
				this.$memoryCards.off("click", this.cardClicked.bind(this));
			},
			addEvent: function() {
				this.$memoryCards.on("click", this.cardClicked.bind(this));
			},
			cardClicked: function(e) {
				var $card = $(e.target).parents('.card');
				if (!this.flag && !$card.find(".inside").hasClass("matched") && !$card.find(".inside").hasClass("picked")) {
					this.clickedTimes++;
					this.iTimes++;

					$card.find(".inside").addClass("picked");
					if (!this.guess) {
						this.guess = $card.attr("data-id");
					} else if (this.guess == $card.attr("data-id") && !$card.hasClass("picked")) {
						$(".picked").addClass("matched");
						this.guess = null;
						// var iScore = Math.ceil((this.minClickedTimes/(this.minClickedTimes+this.iTimes))*this.reScore);
						var iScore = Math.ceil((this.minClickedTimes/(this.minClickedTimes+this.iTimes))*this.reScore) + Math.ceil((1-this.usedTime/this.duration)*this.reScore);
						this.score += iScore;
						console.log('单次匹配所点次数' + this.iTimes+',单次匹配所获积分：'+iScore);
						this.iTimes = 0;
					} else {
						this.guess = null;
						this.flag = true;
						setTimeout(function() {
							$(".picked").removeClass("picked");
							this.flag = false;
						}.bind(this), 500);
						// 卡牌翻转用时
					}
					if ($(".matched").length == $(".card").length) {
						this.win();
					}
				}
			},
			win: function() {
				this.flag = true;
				this.clearTimer();
				console.log('过关所点总次数' + this.clickedTimes+',过关总得分：'+this.score);
				this.clickedTimes = 0;
				// setTimeout(this.showModal.bind(this), 400);
				setTimeout(function() {
					this.showModal()
					this.checkLevel();
				}.bind(this), 500);
			},
			restart: function() {
				this.level = 1;
				this.lifeValue = 2;
				this.score = 0;
				this.hideModal();
				this.start();
			},
			showModal: function() {
				this.$modal.css('display', 'block');
			},
			hideModal: function() {
				this.$modal.css('display', 'none');
			},
			reset: function() {
				if (this.lifeValue <= 0) {
					console.log('生命值用完，无法再来~');
					return;
				}
				this.hideModal();
				this.start();
			},
			nextLevel: function() {
				if (this.isOutTime) {
					console.log('超时未过关，无法进入下一关！');
					return;
				}
				if (!this.checkLevel()) {
					return;
				}
				this.level++;
				this.hideModal();
				this.start();
			},
			// 从第几关开始游戏,默认第一关
			setLevel: function(level) {
				// this.level = level <= 0 ? 1 : level > this.totalLevel ? this.totalLevel : level || 1;
				if (level <= 0 || level > this.totalLevel) {
					return;
				}
				this.start();
			},
			checkLevel: function() {
				if (this.level >= this.totalLevel) {
					alert('通关啦~');
					this.rmoveEvent();
					return false;
				} else {
					return true;
				}
			},
			clearTimer: function() {
				this.timer && clearInterval(this.timer);
			},
			setTimer: function() {
				this.timer = setInterval(function() {
					this.usedTime++;
					this.updateTime();
				}.bind(this), 1000);
			},
			updateTime: function() {
				console.log('剩余时间' + (this.duration - this.usedTime) + 's');
				if (this.usedTime >= this.duration) {
					console.log('超时~');
					this.isOutTime = true;
					this.clearTimer();
					this.showModal();
					this.lifeValue--;
					return;
				}

			},
			updateLevel: function() {
				console.log('第' + this.level + '关');
			},
			shuffleCards: function(cardsArray) {
				this.$cards = $(this.shuffle(this.arrCards));
			},
			// Fisher--Yates Algorithm -- https://bost.ocks.org/mike/shuffle/
			shuffle: function(array) {
				var counter = array.length,
					temp, index;
				while (counter > 0) {
					index = Math.floor(Math.random() * counter);
					counter--;
					temp = array[counter];
					array[counter] = array[index];
					array[index] = temp;
				}
				return array;
			},
			buildHTML: function() {
				var frag = '';
				this.$cards.each(function(k, v) {
					frag += '<div class="card" data-id="' + v.id + '">\
								<div class="inside">\
									<div class="front"><img src="' + v.img + '"\
									alt="' + v.name + '" /></div>\
									<div class="back"><img src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/74196/codepen-logo.png"\
									alt="Codepen" /></div>\
								</div>\
							</div>';
				});
				return frag;
			},
			pushInfo: function() {
				// num 第几把, level 第几关,
				this.userInfo.push({
					"num": this.num,
					"level": this.level,
					"score": this.score,
					"usedTime": this.usedTime,
					"lifeValue": this.lifeValue
				});
			}
		}
		var m = new Memory(dataLevel);
		// m.setLevel(3);
		m.start();
		m.ctls.on('click', function(e) {
			var val = $(e.target).val();
			switch (val) {
				case "reset":
					m.reset();
					break;
				case "restart":
					m.restart();
					break;
				case "nextLevel":
					m.nextLevel();
					break;
			}
		});
	</script>
</body>
</html>