<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Document</title>
	<style type="text/css">
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
			-webkit-tap-highlight-color: rgba(0, 0, 0, 0);
		}
		.wrap {
			position: relative;
		}

		.game {
			width: 600px;
			margin: 0 auto;
			overflow: hidden;
		}
		.card {
			position: relative;
			float: left;
			width: 150px;
			height: 150px;
			text-align: center;
			-webkit-perspective: 500px;
			perspective: 500px;
			cursor: pointer;
			border: 1px solid #000;
			overflow: hidden;
		}
		.card .inside {
			width: 100%;
			height: 100%;
			display: block;
			transform-style: preserve-3d;
			transition: 0.4s ease-in-out;
			background: white;
		}
		.card .inside.picked, .card .inside.matched {
			transform: rotateY(180deg);
		}
		.card .inside.matched {
			animation: 1s matchAnim ease-in-out;
			animation-delay: 0.4s;
		}
		.card .front,
		.card .back {
			-webkit-backface-visibility: hidden;
			backface-visibility: hidden;
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			padding: 20px;
		}
		.card .front img,
		.card .back img {
			display: block;
			max-width: 100%;
			max-height: 100%;
			margin: 0 auto;
		}
		.card .front {
			transform: rotateY(-180deg);
		}
		.card .back {
			transform: rotateX(0deg);
		}
		@keyframes matchAnim {
			0% {
				background: #bcffcc;
			}
			100% {
				background: white;
			}
		}
		/* ----del----- */
		.modal{display: none;position: fixed;left: 0;top: 0;right: 0;bottom: 0;background-color: rgba(0,0,0,0.8);}
		.control{
			position: absolute;left: 100px;right: 100px;top: 50%;
			display: flex;
			flex-flow: row nowrap;
			justify-content: space-around;
		}
		.control input{height: 30px;line-height: 30px;}
	</style>
</head>
<body>
	<div class="wrap">
		<div class="game"></div>
	</div>
	<div class="modal">
		<div class="control">
			<input type="button" value="start" />
			<input type="button" value="reset" />
			<input type="button" value="nextLevel" />
			<input type="button" value="pause" />
		</div>
	</div>
	<script src="http://wq.360buyimg.com/fd/promote/base/zepto.min.js"></script>
	<script type="text/javascript">
		var dataLevel = [{
							"level":1,
							"data":[
										{name: "css3",img: "https://s3-us-west-2.amazonaws.com/s.cdpn.io/74196/css3-logo.png",id: 1},
										{name: "html5",img: "https://s3-us-west-2.amazonaws.com/s.cdpn.io/74196/html5-logo.png",id: 2}
									],
							"duration":5
						},{
							"level":2,
							"data":[
										{name: "css3",img: "https://s3-us-west-2.amazonaws.com/s.cdpn.io/74196/css3-logo.png",id: 1},
										{name: "html5",img: "https://s3-us-west-2.amazonaws.com/s.cdpn.io/74196/html5-logo.png",id: 2},
										{name: "jquery",img: "https://s3-us-west-2.amazonaws.com/s.cdpn.io/74196/jquery-logo.png",id: 3}
									],
							"duration":8
						},{
							"level":3,
							"data":[
										{name: "css3",img: "https://s3-us-west-2.amazonaws.com/s.cdpn.io/74196/css3-logo.png",id: 1},
										{name: "html5",img: "https://s3-us-west-2.amazonaws.com/s.cdpn.io/74196/html5-logo.png",id: 2},
										{name: "jquery",img: "https://s3-us-west-2.amazonaws.com/s.cdpn.io/74196/jquery-logo.png",id: 3},
										{name: "javascript",img: "https://s3-us-west-2.amazonaws.com/s.cdpn.io/74196/js-logo.png",id: 4}
									],
							"duration":10
						},{
							"level":4,
							"data":[
										{name: "css3",img: "https://s3-us-west-2.amazonaws.com/s.cdpn.io/74196/css3-logo.png",id: 1},
										{name: "html5",img: "https://s3-us-west-2.amazonaws.com/s.cdpn.io/74196/html5-logo.png",id: 2},
										{name: "jquery",img: "https://s3-us-west-2.amazonaws.com/s.cdpn.io/74196/jquery-logo.png",id: 3},
										{name: "javascript",img: "https://s3-us-west-2.amazonaws.com/s.cdpn.io/74196/js-logo.png",id: 4},
										{name: "node",img: "https://s3-us-west-2.amazonaws.com/s.cdpn.io/74196/nodejs-logo.png",id: 5}
									],
							"duration":12
						},{
							"level":5,
							"data":[
										{name: "css3",img: "https://s3-us-west-2.amazonaws.com/s.cdpn.io/74196/css3-logo.png",id: 1},
										{name: "html5",img: "https://s3-us-west-2.amazonaws.com/s.cdpn.io/74196/html5-logo.png",id: 2},
										{name: "jquery",img: "https://s3-us-west-2.amazonaws.com/s.cdpn.io/74196/jquery-logo.png",id: 3},
										{name: "javascript",img: "https://s3-us-west-2.amazonaws.com/s.cdpn.io/74196/js-logo.png",id: 4},
										{name: "node",img: "https://s3-us-west-2.amazonaws.com/s.cdpn.io/74196/nodejs-logo.png",id: 5},
										{name: "python",img: "https://s3-us-west-2.amazonaws.com/s.cdpn.io/74196/python-logo.png",id: 6}
									],
							"duration":16
						}];
	</script>
	<script type="text/javascript">
		/**
		 * 单关数据重新更新
		 * 单次匹配成功用时
		 * 得分计算
		 * start
		 * reset
		 * restart
		 * nextLevel
		 * pause
		 */
		var userInfo = [];
		function Memory(data){
			this.$game = $(".game");
			this.$modal = $(".modal");
			this.ctls = $('.control input[type="button"]');

			this.data = data || [];
			this.totalLevel = this.data.length;
			this.level = 1;
		}
		Memory.prototype = {
			init: function(){
				this.info = this.data[this.level-1];
				this.arrData = this.info.data || [];
				this.duration = this.info.duration || 0;
				this.usedTime = 0;
				this.paused = false;
				this.guess = null;
				this.arrCards = this.arrData.concat(this.arrData);
				this.setHtml();
				this.updateLevel();
			},
			start: function(){
				this.init();
				this.binding();
			},
			setHtml: function(){
				this.shuffleCards(this.arrCards);
				this.html = this.buildHTML();
				this.$game.html(this.html);
				this.$memoryCards = $(".card");
			},
			binding: function() {
				this.$memoryCards.on("click", this.cardClicked.bind(this));
			},
			cardClicked: function(e) {
				var _this = this;
				var $card = $(e.target).parents('.card');
				if (!this.paused && !$card.find(".inside").hasClass("matched") && !$card.find(".inside").hasClass("picked")) {
					$card.find(".inside").addClass("picked");
					if (!this.guess) {
						this.guess = $card.attr("data-id");
					} else if (this.guess == $card.attr("data-id") && !$card.hasClass("picked")) {
						$(".picked").addClass("matched");
						this.guess = null;
					} else {
						this.guess = null;
						this.paused = true;
						setTimeout(function() {
							$(".picked").removeClass("picked");
							_this.paused = false;
						}, 500);
						// 卡牌翻转用时
					}
					if ($(".matched").length == $(".card").length) {
						this.win();
						if (this.checkLevel()) {
							return;
						}
					}
				}
			},
			win: function() {
				this.paused = true;
				setTimeout(this.showModal.bind(this), 400);
			},
			fail: function() {
				// 
			},
			restart: function(){},
			pause: function(){
				this.timer && clearInterval(this.timer);
			},
			showModal: function() {
				this.$modal.css('display', 'block');
			},
			hideModal: function() {
				this.$modal.css('display', 'none');
			},
			reset: function(){
				this.hideModal();
				this.start();
			},
			nextLevel: function(){
				if (this.checkLevel()) {
					return;
				}
				this.level++;
				this.hideModal();
				this.start();
			},
			// 从第几关开始游戏,默认第一关
			setLevel: function(level){
				this.level = level <= 0 ? 1 : level > this.totalLevel ? this.totalLevel : level || 1;
			},
			checkLevel: function(){
				if (this.level>=this.totalLevel) {
					alert('通关啦~');
					return false;
				}
			},
			pause: function(){
				this.timer && clearInterval(this.timer);
			},
			setTimer: function(){},
			updateTime: function(){
				console.log('剩余时间'+(this.duration-this.usedTime)+'s');
			},
			updateLevel: function(){
				console.log('第'+this.level+'关');
			},
			shuffleCards: function(cardsArray) {
				this.$cards = $(this.shuffle(this.arrCards));
			},
			// Fisher--Yates Algorithm -- https://bost.ocks.org/mike/shuffle/
			shuffle: function(array) {
				var counter = array.length,
					temp, index;
				while (counter > 0) {
					index = Math.floor(Math.random() * counter);
					counter--;
					temp = array[counter];
					array[counter] = array[index];
					array[index] = temp;
				}
				return array;
			},
			buildHTML: function() {
				var frag = '';
				this.$cards.each(function(k, v) {
					frag += '<div class="card" data-id="' + v.id + '"><div class="inside">\
					<div class="front"><img src="' + v.img + '"\
					alt="' + v.name + '" /></div>\
					<div class="back"><img src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/74196/codepen-logo.png"\
					alt="Codepen" /></div></div>\
					</div>';
				});
				return frag;
			}
		}
		var m = new Memory(dataLevel);
		m.start();
		m.ctls.on('click',function(e){
			var val = $(e.target).val();
			switch (val) {
				case "start":
					m.start();
					break;
				case "reset":
					m.reset();
					break;
				case "nextLevel":
					m.nextLevel();
					break;
				case "pause":
					m.pause();
					break;
			}
		});
	</script>
</body>
</html>