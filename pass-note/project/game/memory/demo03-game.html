<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Document</title>
	<style type="text/css">
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
			-webkit-tap-highlight-color: rgba(0, 0, 0, 0);
		}
		.wrap {
			position: relative;
		}

		.game {
			width: 600px;
			margin: 0 auto;
			overflow: hidden;
		}
		.card {
			position: relative;
			float: left;
			width: 150px;
			height: 150px;
			text-align: center;
			-webkit-perspective: 500px;
			perspective: 500px;
			cursor: pointer;
			border: 1px solid #000;
			overflow: hidden;
		}
		.card .inside {
			width: 100%;
			height: 100%;
			display: block;
			transform-style: preserve-3d;
			transition: 0.4s ease-in-out;
			background: white;
		}
		.card .inside.picked, .card .inside.matched {
			transform: rotateY(180deg);
		}
		.card .inside.matched {
			animation: 1s matchAnim ease-in-out;
			animation-delay: 0.4s;
		}
		.card .front,
		.card .back {
			-webkit-backface-visibility: hidden;
			backface-visibility: hidden;
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			padding: 20px;
		}
		.card .front img,
		.card .back img {
			display: block;
			max-width: 100%;
			max-height: 100%;
			margin: 0 auto;
		}
		.card .front {
			transform: rotateY(-180deg);
		}
		.card .back {
			transform: rotateX(0deg);
		}
		@keyframes matchAnim {
			0% {
				background: #bcffcc;
			}
			100% {
				background: white;
			}
		}
		/* ----del----- */
		.modal{display: none;position: fixed;left: 0;top: 0;right: 0;bottom: 0;background-color: rgba(0,0,0,0.8);}
		.restart,.nextLevel{position: absolute;top: 50%;transform: translate(0, -50%);}
		.restart{left: 300px;}
		.nextLevel{right: 300px;}
	</style>
</head>
<body>
	<div class="wrap">
		<div class="game"></div>
	</div>
	<div class="modal">
		<input type="button" class="restart" value="restart">
		<input type="button" class="nextLevel" value="nextLevel">
	</div>
	<script src="http://wq.360buyimg.com/fd/promote/base/zepto.min.js"></script>
	<script type="text/javascript">
		/**
		 * 单关数据重新更新
		 * 单次匹配成功用时
		 * 得分控制
		 */
		var dataLevel = [{
							"level":1,
							"data":[
										{name: "css3",img: "https://s3-us-west-2.amazonaws.com/s.cdpn.io/74196/css3-logo.png",id: 1},
										{name: "html5",img: "https://s3-us-west-2.amazonaws.com/s.cdpn.io/74196/html5-logo.png",id: 2}
									],
							"duration":5
						},{
							"level":2,
							"data":[
										{name: "css3",img: "https://s3-us-west-2.amazonaws.com/s.cdpn.io/74196/css3-logo.png",id: 1},
										{name: "html5",img: "https://s3-us-west-2.amazonaws.com/s.cdpn.io/74196/html5-logo.png",id: 2},
										{name: "jquery",img: "https://s3-us-west-2.amazonaws.com/s.cdpn.io/74196/jquery-logo.png",id: 3}
									],
							"duration":8
						},{
							"level":3,
							"data":[
										{name: "css3",img: "https://s3-us-west-2.amazonaws.com/s.cdpn.io/74196/css3-logo.png",id: 1},
										{name: "html5",img: "https://s3-us-west-2.amazonaws.com/s.cdpn.io/74196/html5-logo.png",id: 2},
										{name: "jquery",img: "https://s3-us-west-2.amazonaws.com/s.cdpn.io/74196/jquery-logo.png",id: 3},
										{name: "javascript",img: "https://s3-us-west-2.amazonaws.com/s.cdpn.io/74196/js-logo.png",id: 4}
									],
							"duration":10
						},{
							"level":4,
							"data":[
										{name: "css3",img: "https://s3-us-west-2.amazonaws.com/s.cdpn.io/74196/css3-logo.png",id: 1},
										{name: "html5",img: "https://s3-us-west-2.amazonaws.com/s.cdpn.io/74196/html5-logo.png",id: 2},
										{name: "jquery",img: "https://s3-us-west-2.amazonaws.com/s.cdpn.io/74196/jquery-logo.png",id: 3},
										{name: "javascript",img: "https://s3-us-west-2.amazonaws.com/s.cdpn.io/74196/js-logo.png",id: 4},
										{name: "node",img: "https://s3-us-west-2.amazonaws.com/s.cdpn.io/74196/nodejs-logo.png",id: 5}
									],
							"duration":12
						},{
							"level":5,
							"data":[
										{name: "css3",img: "https://s3-us-west-2.amazonaws.com/s.cdpn.io/74196/css3-logo.png",id: 1},
										{name: "html5",img: "https://s3-us-west-2.amazonaws.com/s.cdpn.io/74196/html5-logo.png",id: 2},
										{name: "jquery",img: "https://s3-us-west-2.amazonaws.com/s.cdpn.io/74196/jquery-logo.png",id: 3},
										{name: "javascript",img: "https://s3-us-west-2.amazonaws.com/s.cdpn.io/74196/js-logo.png",id: 4},
										{name: "node",img: "https://s3-us-west-2.amazonaws.com/s.cdpn.io/74196/nodejs-logo.png",id: 5},
										{name: "python",img: "https://s3-us-west-2.amazonaws.com/s.cdpn.io/74196/python-logo.png",id: 6}
									],
							"duration":16
						}];
		var level = 1;
		var dataDetail = [];
		function Memory() {
			this.$game = $(".game");
			this.$modal = $(".modal");
			this.$restartBtn = $(".restart");
			this.$nextLevel = $(".nextLevel");
		}
		Memory.prototype = {
			init: function(data) {
				this.level = data.level || 0;
				this.data = data.data || [];
				this.timeLimit = data.duration || 0;	// 5s
				this.paused = false;
				this.guess = null;
				this.arrCards = this.data.concat(this.data);
				this.shuffleCards(this.arrCards);
				this.setup();
			},
			start: function(){
				this.timer = null;
				this.updataTime(this.timeLimit);
				this.setTimer();
				this.binding();
			},
			setup: function() {
				this.html = this.buildHTML();
				this.$game.html(this.html);
				this.$memoryCards = $(".card");
			},
			binding: function() {
				this.$memoryCards.on("click", this.cardClicked.bind(this));
				this.$restartBtn.on("click", this.reset.bind(this));
				this.$nextLevel.on("click", this.nextLevel.bind(this));
			},
			updataTime: function(m) {
				console.log('剩余时间：'+m+'s');
			},
			setTimer: function() {
				var _this = this;
				this.timer = setInterval(function(){
					_this.timeLimit--;
					_this.updataTime(_this.timeLimit);
					if (_this.timeLimit<=0) {
						_this.clearTimer();
						_this.showModal();
						console.log('超时了~');
						return;
					}
				}, 1000);
			},
			clearTimer: function (){
				this.timer && clearInterval(this.timer);
			},
			updateInfo: function() {
				// 
			},
			cardClicked: function(e) {
				var _this = this;
				var $card = $(e.target).parents('.card');
				if (!_this.paused && !$card.find(".inside").hasClass("matched") && !$card.find(".inside").hasClass("picked")) {
					$card.find(".inside").addClass("picked");
					if (!_this.guess) {
						_this.guess = $card.attr("data-id");
					} else if (_this.guess == $card.attr("data-id") && !$card.hasClass("picked")) {
						$(".picked").addClass("matched");
						_this.guess = null;
					} else {
						_this.guess = null;
						_this.paused = true;
						setTimeout(function() {
							$(".picked").removeClass("picked");
							_this.paused = false;
						}, 500);
						// 卡牌翻转用时
					}
					if ($(".matched").length == $(".card").length) {
						_this.win();
					}
				}
			},
			win: function() {
				this.paused = true;
				this.clearTimer();
				setTimeout(this.showModal.bind(this), 400);
			},
			fail: function() {
				this.reset();
			},
			showModal: function() {
				this.$modal.css('display', 'block');
			},
			hideModal: function() {
				this.$modal.css('display', 'none');
			},
			reset: function() {
				this.clearTimer();
				this.hideModal();
				this.$game.css('display', 'block');
				this.shuffleCards(this.arrCards);
				this.setup();
				this.init(dataLevel[level-1]);
				this.start();
			},
			nextLevel: function(){
				level++;
				if (level>dataLevel.length) {
					alert('通关~');
					return;
				}
				this.init(dataLevel[level-1].data);
				this.reset();
			},
			shuffleCards: function(cardsArray) {
				this.$cards = $(this.shuffle(this.arrCards));
			},
			// Fisher--Yates Algorithm -- https://bost.ocks.org/mike/shuffle/
			shuffle: function(array) {
				var counter = array.length,
					temp, index;
				while (counter > 0) {
					index = Math.floor(Math.random() * counter);
					counter--;
					temp = array[counter];
					array[counter] = array[index];
					array[index] = temp;
				}
				return array;
			},
			buildHTML: function() {
				var frag = '';
				this.$cards.each(function(k, v) {
					frag += '<div class="card" data-id="' + v.id + '"><div class="inside">\
					<div class="front"><img src="' + v.img + '"\
					alt="' + v.name + '" /></div>\
					<div class="back"><img src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/74196/codepen-logo.png"\
					alt="Codepen" /></div></div>\
					</div>';
				});
				return frag;
			}
		};
		var m = new Memory();
		m.init(dataLevel[level-1]);
		m.start();
	</script>
</body>
</html>